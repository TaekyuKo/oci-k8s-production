---
# Prometheus + Grafana 모니터링 스택 설치

- name: Install Prometheus and Grafana
  hosts: k8s_master[0]
  become: yes
  roles:
    - ../roles/monitoring
  
  post_tasks:
    - name: Wait for monitoring pods
      shell: kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=prometheus -n monitoring --timeout=300s
      become_user: ubuntu
      changed_when: false
      
    - name: Get Grafana admin password
      shell: kubectl get secret -n monitoring grafana -o jsonpath='{.data.admin-password}' | base64 -d
      become_user: ubuntu
      register: grafana_password
      changed_when: false
      
    - name: Display Grafana access info
      debug:
        msg:
          - "✓ Grafana available at: http://{{ ansible_host }}:30000"
          - "  Username: admin"
          - "  Password: {{ grafana_password.stdout }}"

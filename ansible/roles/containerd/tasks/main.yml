---
# containerd 설치 및 설정
# - containerd 패키지 설치
# - systemd cgroup 드라이버 설정
# - 서비스 시작 및 활성화

- name: Install containerd
  apt:
    name:
      - containerd
      - runc
    state: present

- name: Create containerd config directory
  file:
    path: /etc/containerd
    state: directory
    mode: '0755'

- name: Generate default containerd configuration
  shell: containerd config default > /etc/containerd/config.toml
  args:
    creates: /etc/containerd/config.toml

- name: Enable SystemdCgroup in containerd
  lineinfile:
    path: /etc/containerd/config.toml
    regexp: '^\s*SystemdCgroup\s*=\s*false'
    line: '            SystemdCgroup = true'
    backrefs: yes

- name: Restart and enable containerd
  systemd:
    name: containerd
    state: restarted
    enabled: yes
    daemon_reload: yes

- name: Wait for containerd to be ready
  wait_for:
    timeout: 10
  delegate_to: localhost

- name: Verify containerd is running
  systemd:
    name: containerd
    state: started
  register: containerd_status
  
- name: Display containerd status
  debug:
    msg: "✓ containerd is {{ containerd_status.status.ActiveState }}"

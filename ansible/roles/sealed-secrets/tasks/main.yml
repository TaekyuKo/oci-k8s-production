---
# Sealed Secrets Controller 설치

- name: Install Sealed Secrets controller
  shell: |
    helm upgrade --install sealed-secrets sealed-secrets/sealed-secrets \
      --namespace kube-system \
      --wait --timeout 5m
  become_user: ubuntu
  environment:
    KUBECONFIG: /home/ubuntu/.kube/config
  args:
    creates: /home/ubuntu/.sealed-secrets-installed

- name: Download kubeseal CLI
  get_url:
    url: https://github.com/bitnami-labs/sealed-secrets/releases/download/v{{ sealed_secrets_version }}/kubeseal-{{ sealed_secrets_version }}-linux-amd64.tar.gz
    dest: /tmp/kubeseal.tar.gz
    mode: '0644'

- name: Extract kubeseal CLI
  unarchive:
    src: /tmp/kubeseal.tar.gz
    dest: /usr/local/bin
    remote_src: yes
    creates: /usr/local/bin/kubeseal

- name: Mark Sealed Secrets as installed
  file:
    path: /home/ubuntu/.sealed-secrets-installed
    state: touch
    owner: ubuntu
    group: ubuntu
